# 구독간편조회 웹앱 개발 작업내역

## 프로젝트 개요
- **목표**: AppSheet 구독간편조회 앱을 직접 코딩된 웹 애플리케이션으로 변환
- **데이터베이스**: MariaDB on Synology NAS (192.168.0.200:3307)
- **기술스택**: Node.js + Express + MariaDB + HTML/CSS/JavaScript
- **데이터**: 20,377개 제품 레코드 (CSV 임포트)

## 완료된 작업 항목

### 1. 프로젝트 초기 설정
- ✅ Node.js 프로젝트 생성 및 의존성 설치
- ✅ MariaDB 연결 설정 (idvvbi.com:3307)
- ✅ 데이터베이스 사용자 'app_user' 생성 및 권한 설정
- ✅ Express 서버 구성 (포트: 3006)

### 2. 데이터베이스 구축
- ✅ MariaDB 테이블 생성 (한글 컬럼명 사용)
- ✅ CSV 데이터 임포트 (4.4MB, 20,377개 레코드)
- ✅ 데이터 정합성 확인 및 빈 값 처리
- ✅ 관리유형 컬럼 확인 및 추가 처리

### 3. UI/UX 구현
- ✅ E-mart 스타일 전체 레이아웃 구현
- ✅ 좌측 가격 계산기 사이드바
  - 정상 구독료, 추가혜택, 총 혜택 표시
  - 실시간 가격 계산 기능
- ✅ 우측 제품 선택 그리드 영역
  - 선택된 제품 카드 표시
  - 동적 제품 추가 버튼 배치
- ✅ 반응형 디자인 적용

### 4. 제품 선택 모달 시스템
- ✅ 7단계 순차 선택 프로세스 구현:
  1. 제품군
  2. 모델명
  3. 결합유형
  4. 계약기간
  5. **관리유형** (새로 추가)
  6. 방문주기
  7. 선납
- ✅ 단계별 진행 표시기
- ✅ 원클릭 자동 진행 기능
- ✅ 검색 기능 (10개 이상 옵션 시 자동 표시)
- ✅ 이전 단계 되돌아가기 기능

### 5. 백엔드 API 개발
- ✅ 제품 목록 조회 API (`/api/products`)
- ✅ 카테고리 목록 API (`/api/categories`)
- ✅ 단계별 옵션 조회 API (`/api/product-options/:field`)
- ✅ 정확한 제품 검색 API (`/api/products/find-exact`)
- ✅ 한글 컬럼명 및 특수문자 처리
- ✅ 빈 값 대체 로직 (방문없음, 선납없음, 관리없음)

### 6. JavaScript 로직 구현
- ✅ SubscriptionCalculator 클래스
  - 제품 추가/제거 기능
  - 실시간 가격 계산
  - 제품 카드 렌더링
- ✅ ProductSelectionModal 클래스
  - 7단계 모달 진행 관리
  - 동적 옵션 로딩
  - 검색 및 필터링
- ✅ DOM 초기화 순서 최적화
- ✅ 안전한 이벤트 리스너 등록

### 7. 데이터 처리 및 최적화
- ✅ 중복 데이터 제거
- ✅ 한글 인코딩 처리
- ✅ 빈 값/NULL 값 적절한 기본값으로 변환
- ✅ SQL 쿼리 최적화 (인덱싱 고려)

## 주요 기술 결정사항

### 데이터베이스 설계
```sql
-- 주요 컬럼 구조
- id (int): 기본키
- 제품군 (varchar): 제품 카테고리
- 모델명 (varchar): 제품명
- 결합유형 (varchar): 결합 옵션
- 계약기간 (varchar): 계약 기간
- 관리유형 (varchar): 관리 서비스 유형
- 방문주기 (varchar): 서비스 방문 주기
- 선납 (varchar): 선납 옵션
- 월요금 (varchar): 월 구독료
```

### API 엔드포인트
```javascript
GET /api/categories - 제품군 목록
GET /api/products - 제품 목록 (페이징, 검색)
GET /api/product-options/:field - 단계별 옵션 조회
GET /api/products/find-exact - 정확한 조건 검색
```

### UI 컴포넌트 구조
```
Container
├── Header (검색바)
├── Main Content
    ├── Calculator Sidebar (가격 계산기)
    └── Products Main (제품 그리드)
        ├── Product Cards (선택된 제품들)
        └── Add Product Card (추가 버튼)
└── Product Selection Modal (7단계 선택)
```

## 현재 파일 구조
```
D:\SynologyDrive\web\docker\9dok_3\
├── package.json - 프로젝트 설정
├── server.js - Express 서버 (포트 3006)
├── public/
    ├── index.html - 메인 페이지
    ├── style.css - 전체 스타일시트
    ├── script.js - 메인 JavaScript 로직
    └── product-modal.js - 모달 JavaScript 로직
└── 작업내역.md - 이 파일
```

## 최신 업데이트 (2025-08-09)

### 관리유형 단계 추가
- ✅ 모달 단계를 6단계에서 7단계로 확장
- ✅ 관리유형을 5단계로 추가 (방문주기 이전)
- ✅ HTML 단계 표시기 업데이트
- ✅ JavaScript 로직 업데이트 (stepTitles, stepFields, selections)
- ✅ 서버 API allowedFields에 관리유형 추가
- ✅ 빈 값 처리 로직에 '관리없음' 추가

### 선택 순서 최종 확정
1. 제품군 선택
2. 모델명 선택  
3. 결합유형 선택
4. 계약기간 선택
5. **관리유형 선택** ← 새로 추가
6. 방문주기 선택
7. 선납 선택

## 다음 작업 예정 사항
- [ ] 전체 기능 통합 테스트
- [ ] 성능 최적화 (대용량 데이터 처리)
- [ ] 에러 핸들링 강화
- [ ] 사용자 경험 개선 (로딩 상태 표시)

## 접속 정보
- **웹 서버**: http://localhost:3008
- **데이터베이스**: idvvbi.com:3307 (MariaDB)
- **사용자**: app_user / AppUser2024!@#
- **데이터베이스명**: subscription_db

---
*작업 완료일: 2025-08-09*
*개발자: Claude Code Assistant*

## Gemini 추가 작업 (2025-08-09)

### UI 정리
- ✅ 메인 페이지 상단의 미작동 검색창 및 관련 HTML 코드 제거 (`public/index.html`).
- ✅ 제품 카드 이미지 크기 확대 (60px -> 120px) 및 중앙 정렬 (`public/style.css`).
- ✅ 결합 할인 안내 팝업의 폰트를 기본 폰트로 수정하고, 모델별 할인액을 표시하도록 개선 (`public/script.js`, `public/style.css`).
- ✅ **버그 수정**: `formatPrice` 함수에 `undefined` 값이 전달될 경우 `TypeError`가 발생하는 문제 해결 (`public/script.js`).

### '모델별 이미지' 데이터 연동
- ✅ `구독카달로그 - 모델별이미지.csv` 파일 임포트를 위한 신규 DB 테이블 `model_images` 생성.
- ✅ 테이블 생성 스크립트 (`scripts/create-image-table.js`) 작성 및 실행.
- ✅ CSV 데이터 임포트 스크립트 (`scripts/import-images.js`) 작성 및 실행.
- ✅ **트러블슈팅**:
    - DB 접속 정보 불일치 문제 해결 (여러 파일에 흩어져 있던 접속 정보를 `app_user` 기준으로 통일).
    - `mariadb` 드라이버의 bulk insert 구문 오류 수정 후 데이터 임포트 성공 (2,267건).

### 팝업창 및 UI 개선
- ✅ 제품 2개 이상 선택 시 뜨는 팝업창 제목을 '신규결합 자동 반영'으로 변경 (`public/script.js`).
- ✅ '신규결합 자동 반영' 팝업창의 너비 조정 (`public/style.css`).
  - `max-width`를 `590px !important`로 설정하여 텍스트가 한 줄에 표시되도록 개선.
- ✅ 제품 선택 모달 내 '계약기간' 버튼 크기 조정 및 정렬 개선 (`public/style.css`).
  - `.options-grid`의 `minmax` 값을 `150px`로 조정하여 버튼이 다음 줄로 넘어가지 않도록 개선.
- ✅ '계약기간' 옵션 표시 순서 변경 (`public/product-modal.js`).
  - 6년, 5년, 4년, 3년 순으로 내림차순 정렬되도록 로직 추가.
- ✅ 선택된 제품 카드 레이아웃 개선 (`public/script.js`, `public/style.css`).
  - 제품 이미지 좌측, 모델명 및 선택 타입 내용 우측으로 배치되도록 HTML 구조 및 CSS (`.product-header-content`) 추가.

---
*작업 완료일: 2025-08-09*
*개발자: Gemini Code Assistant*

## Claude 추가 작업 (2025-08-09)

### UI/UX 개선
- ✅ **모델명 폰트 크기 자동 조정**: 제품 선택 모달에서 모델명 길이에 따라 폰트 크기 자동 조정 (한 줄 표시)
  - 텍스트 길이별 폰트 크기: 10자 이하(14px) ~ 40자 초과(6px)
  - `white-space: nowrap`로 줄바꿈 방지
- ✅ **메인화면 제품 카드 모델명 최적화**: 선택된 제품 카드의 모델명도 길이에 따라 폰트 크기 자동 조정
- ✅ **모달 스크롤바 커스터마이징**: 둥근 모서리가 스크롤바로 인해 각져 보이는 문제 해결
  - `.modal-scroll-content` 분리로 스크롤 영역 격리
  - E-mart 브랜드 컬러의 커스텀 스크롤바 적용

### 좌측 계산기 개선
- ✅ **중복 섹션 제거**: "총혜택" 섹션 제거 (추가혜택과 중복)
- ✅ **추가혜택 토글 기능 추가**: 클릭 시 세부항목 표시/숨김 기능
  - 화살표 회전 애니메이션 (▼/▲)
  - 프로모션할인, 결합할인, 제휴카드 할인 세부내역 표시
- ✅ **선납금액 섹션 추가**: 선납 옵션 선택 시 총 선납금액 표시
  - 데이터베이스 `선납금액` 필드 값 활용
  - 제품별 선납금액 및 선납옵션 세부내역 표시
  - 오렌지 색상 테마로 구분
- ✅ **선납 세부항목 폰트 자동 조정**: 모델명 길이에 따라 폰트 크기 자동 조정으로 줄바꿈 방지

### 제휴카드 기능 개선
- ✅ **사용금액 옵션 정렬**: 제휴카드 선택 시 금액 기준 오름차순 정렬
  - "30만원 이상" → "80만원 이상" → "160만원 이상" 순서
  - `extractAmountFromUsage()` 함수로 금액 추출 및 정렬

### 기술적 개선사항
- ✅ **반응형 폰트 시스템**: `clamp()` 함수 대신 단계별 고정 폰트 크기로 안정성 향상
- ✅ **모달 구조 최적화**: HTML 구조 분리로 스크롤과 고정 영역 명확히 구분
- ✅ **동적 폰트 조정**: JavaScript로 텍스트 길이 감지 후 실시간 폰트 크기 적용

---
*작업 완료일: 2025-08-09*
*개발자: Claude Code Assistant*

## Claude SSO 인증 시스템 도입 작업 (2025-08-10)

### SSO 통합 인증 시스템 구현
- ✅ **JWT 기반 인증 시스템 구현**: LGEmart 통합 인증 서버와 연동
  - `auth/authMiddleware.js`: JWT 토큰 검증, AuthClient 클래스 구현
  - `auth/authRoutes.js`: 로그인/로그아웃/토큰갱신/사용자정보 API 엔드포인트
  - jsonwebtoken 패키지 설치 및 설정

### 클라이언트 측 인증 구현
- ✅ **브라우저 인증 클라이언트**: 자동 로그인 처리 및 토큰 관리
  - `public/auth.js`: AuthClient 클래스로 로그인/토큰관리/API요청 래퍼
  - localStorage 기반 토큰 저장 및 자동 갱신
  - 자동 로그인 폼 표시 및 인증 상태 관리
  - 사용자 정보 표시 및 로그아웃 기능

### 모든 페이지 인증 적용
- ✅ **HTML 페이지 인증 스크립트 포함**:
  - `public/channel-select.html`: 채널 선택 페이지 인증 추가
  - `public/em/index.html`: 이마트 페이지 인증 추가
  - `public/hp/index.html`: 홈플러스 페이지 인증 추가
  - `public/et/index.html`: 전자랜드 페이지 인증 추가

### API 보안 강화
- ✅ **모든 API 엔드포인트 인증 필수화**:
  - `/api/products`: 제품 목록 조회 API 인증 적용
  - `/api/categories`: 카테고리 목록 API 인증 적용
  - `/api/products/find-exact`: 정확 검색 API 인증 적용
  - `/api/products/:id`: 제품 상세 API 인증 적용
  - `/api/product-options/:field`: 옵션 조회 API 인증 적용
  - `/api/partner-cards`: 제휴카드 API 인증 적용
  - `authenticateToken` + `requireActiveUser` 미들웨어 적용

### 인증 플로우 구현
- ✅ **완전한 SSO 인증 플로우**:
  - 페이지 접속 시 자동 인증 상태 확인
  - 미인증 시 자동 로그인 모달 표시
  - JWT 토큰 자동 갱신 (Access/Refresh Token)
  - 토큰 만료 시 자동 재인증 처리
  - 인증 실패 시 자동 로그아웃 및 재로그인 유도

### 사용자 경험 개선
- ✅ **UX 최적화**:
  - 고정된 사용자 정보 표시 (우상단)
  - 원클릭 로그아웃 기능
  - API 요청 자동 토큰 포함 및 재시도
  - 인증 오류 시 사용자 친화적 메시지 표시

### 보안 고려사항 적용
- ✅ **SSO_INTEGRATION_GUIDE.md 기반 구현**:
  - HS256 알고리즘 JWT 토큰 검증
  - Access Token (1시간) + Refresh Token (7일) 구조
  - 인증 서버 URL 환경변수 설정 지원
  - HTTPS/보안 연결 고려사항 반영
  - 활성 사용자 및 권한 확인 로직

### 기술적 구현사항
- ✅ **Express.js 서버 통합**:
  - `/auth` 라우트 그룹 추가
  - 정적 파일 서빙에 `auth.js` 추가
  - AuthClient 인스턴스 전역 생성 및 활용
  - 미들웨어 체인 구성 (인증 → 권한확인 → API 처리)

---
*작업 완료일: 2025-08-10*
*개발자: Claude Code Assistant*

## Claude 실제 인증 서버 연동 작업 (2025-08-10)

### 실제 LGEmart 인증 서버 연동
- ✅ **테스트 모드 제거**: 목업 계정 및 토큰 검증 로직 제거
- ✅ **실제 인증 서버 연결**: `http://localhost:3005` 인증 서버와 연동
- ✅ **응답 구조 대응**: 실제 서버 응답 형식에 맞춰 클라이언트 코드 수정
  - `tokens` 객체가 아닌 직접 `access_token`, `refresh_token` 응답 처리

### 토큰 처리 개선
- ✅ **로그인 응답 처리**: 실제 서버 응답 구조 (`access_token`, `refresh_token` 직접 포함) 대응
- ✅ **토큰 갱신 로직**: refresh token 응답 구조도 동일하게 수정
- ✅ **JWT 시크릿 키**: 실제 인증 서버와 동일한 키 설정 (`synology-auth-secret-key`)

### API 엔드포인트 개선
- ✅ **`/auth/me` 엔드포인트**: 인증 서버에 직접 사용자 정보 요청하도록 수정
  - 인증 서버 `/user/profile` 엔드포인트 호출
  - 연결 실패 시 JWT 토큰 검증으로 fallback 처리
  - 401/403 상태 코드 적절히 전달

### 실제 로그인 테스트 결과
- ✅ **성공적인 인증**: 실제 사용자 계정으로 로그인 성공
  - 직원번호: `1017701` (하동훈)
  - JWT 토큰 발급 및 사용자 정보 수신 확인
  - `KTcs` 회사, Staff 직급, 관리자 권한 확인

### 기술적 수정사항
- ✅ **응답 구조 유연성**: `access_token` 직접 또는 `tokens` 객체 모두 지원
- ✅ **오류 처리 강화**: 인증 서버 연결 실패 시 적절한 fallback 로직
- ✅ **디버깅 로그**: 서버/클라이언트 양쪽에 응답 구조 확인용 로그 추가

### 남은 이슈
- ⚠️ **JWT 시크릿 키 불일치**: 실제 인증 서버의 JWT 시크릿 키 확인 필요
- ⚠️ **토큰 검증**: 현재 JWT 로컬 검증 실패하여 인증 서버 직접 조회로 우회

---
*작업 완료일: 2025-08-10*
*개발자: Claude Code Assistant*

## Claude SSO 인증 서버 연동 및 UI 개선 작업 (2025-08-11)

### 인증 서버 연동 수정
- ✅ **실제 인증 서버 URL 변경**: localhost:3005 → auth.lgemart.com으로 변경
- ✅ **auth.js 경로 문제 해결**: 모든 페이지에서 절대 경로(`/auth.js`)로 통일
  - 채널 페이지 이동 시 인증 유지 문제 해결
  - authServerUrl을 `window.location.origin + '/auth'`로 수정
- ✅ **서버 정적 파일 서빙 설정**: ktcs_logo_black.png, ktcs_logo_white.png 추가

### UI/UX 톤앤매너 개선
- ✅ **참고 사이트 디자인 적용**: 깔끔하고 모던한 스타일로 전면 개편
  - 배경색: #f4f4f8 (연한 회색)
  - 버튼 스타일: 세로 정렬, 고정 너비(350px), 그림자 효과
  - 호버/클릭 애니메이션 효과 추가

### 채널 선택 페이지 개선
- ✅ **달무리 폰트 적용**: 
  - "구독 간편조회" 타이틀
  - "Designed by 하동훈" 서명
  - 채널명 버튼 텍스트
- ✅ **디자인 요소 추가**:
  - 좌측 상단: "Designed by 하동훈" (달무리 폰트, rgba(0,0,0,0.15))
  - 우측 상단: ktcs 로고 (60px, opacity: 0.6)
- ✅ **채널 카드 단순화**: 설명 텍스트 제거, 채널명만 표시
- ✅ **버튼 스타일 개선**: 
  - 흰색 배경, 회색 테두리
  - 3D 그림자 효과
  - 세로 중앙 정렬

### 로그인 화면 개선
- ✅ **달무리 폰트 적용**: 
  - "구독 간편조회" 타이틀
  - 로그인 버튼 텍스트
- ✅ **디자인 요소 추가**:
  - 좌측 상단: "Designed by 하동훈"
  - 우측 상단: ktcs 로고
- ✅ **입력 필드 개선**:
  - "직원번호" → "사번"으로 용어 통일
  - 라벨 제거, placeholder만 사용
  - 텍스트 가운데 정렬
- ✅ **불필요한 텍스트 제거**: "로그인이 필요합니다" 제거
- ✅ **버튼 스타일**: 검정 배경, 달무리 폰트

### 채널 페이지 네비게이션 개선
- ✅ **메인 페이지 복귀 버튼 추가**: "← 채널 선택" 버튼
  - 위치: 헤더 우측 (right: 250px)
  - 로그인 정보 오른쪽에 배치
- ✅ **사용자 정보 위치 조정**: right: 100px로 이동하여 로고와 겹치지 않도록 처리

### 인증 유지 개선
- ✅ **localStorage 활용 최적화**: getCurrentUser 실패 시에도 저장된 사용자 정보 활용
- ✅ **불필요한 리다이렉트 방지**: 토큰이 있을 때 무조건 메인으로 이동하지 않도록 수정

### 기술적 개선사항
- ✅ **Express 정적 파일 서빙 추가**: 로고 이미지 파일 경로 설정
- ✅ **z-index 관리**: 로고(1000), 사용자 정보(1000), 로그인 모달(1001) 계층 정리
- ✅ **일관된 스타일 적용**: 모든 페이지에서 동일한 디자인 언어 사용

---
*작업 완료일: 2025-08-11*
*개발자: Claude Code Assistant*
